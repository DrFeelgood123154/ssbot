Code shared between worker and controller
