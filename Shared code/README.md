Code shared between worker and controller

I made it this way accidentally and just kept it
